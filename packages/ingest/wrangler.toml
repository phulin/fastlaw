name = "fastlaw-ingest"
compatibility_date = "2026-01-20"
main = "src/worker.ts"
compatibility_flags = ["nodejs_compat"]

[limits]
cpu_ms = 300000

[[containers]]
class_name = "IngestContainer"
image = "./Dockerfile"
instance_type = "basic"
max_instances = 60
image_vars = { RUST_PROFILE = "debug" }

[[durable_objects.bindings]]
class_name = "IngestContainer"
name = "INGEST_CONTAINER"

[[durable_objects.bindings]]
class_name = "PackfileDO"
name = "PACKFILE_DO"

[[migrations]]
new_sqlite_classes = ["IngestContainer", "PackfileDO"]
tag = "v1"

[[d1_databases]]
binding = "DB"
database_name = "fastlaw"
database_id = "dc9efc6c-abb6-4790-9546-c3565022c186"
migrations_dir = "../../db/migrations"

[[r2_buckets]]
binding = "STORAGE"
bucket_name = "fastlaw-content"

[ai]
binding = "AI"

[[vectorize]]
binding = "VECTOR_SEARCH_INDEX"
index_name = "fastlaw-search"

[[workflows]]
name = "vector-ingest-workflow"
binding = "VECTOR_WORKFLOW"
class_name = "VectorIngestWorkflow"

[vars]
USC_DOWNLOAD_BASE = "https://uscode.house.gov/download/releasepoints"

[observability]
enabled = true
head_sampling_rate = 1

[observability.logs]
enabled = true
head_sampling_rate = 1
persist = true
invocation_logs = true

[observability.traces]
enabled = true
head_sampling_rate = 1

[env.production]
name = "fastlaw-ingest"
compatibility_date = "2026-01-20"
main = "src/worker.ts"
compatibility_flags = ["nodejs_compat"]

[[env.production.containers]]
class_name = "IngestContainer"
image = "./container-rust/Dockerfile"
instance_type = "basic"
max_instances = 60
image_vars = { RUST_PROFILE = "release" }

[[env.production.durable_objects.bindings]]
class_name = "IngestContainer"
name = "INGEST_CONTAINER"

[[env.production.durable_objects.bindings]]
class_name = "PackfileDO"
name = "PACKFILE_DO"

[[env.production.d1_databases]]
binding = "DB"
database_name = "fastlaw"
database_id = "dc9efc6c-abb6-4790-9546-c3565022c186"
migrations_dir = "../../db/migrations"

[[env.production.r2_buckets]]
binding = "STORAGE"
bucket_name = "fastlaw-content"

[env.production.ai]
binding = "AI"

[[env.production.vectorize]]
binding = "VECTOR_SEARCH_INDEX"
index_name = "fastlaw-search"

[[env.production.workflows]]
name = "vector-ingest-workflow"
binding = "VECTOR_WORKFLOW"
class_name = "VectorIngestWorkflow"

[env.production.vars]
USC_DOWNLOAD_BASE = "https://uscode.house.gov/download/releasepoints"

---
import Base from "../../layouts/Base.astro";
import {
  getChapterById,
  getChapters,
  getSectionsByChapterId
} from "../../lib/sections";

export async function getStaticPaths() {
  const chapters = getChapters();
  return chapters.map((chapter) => ({
    params: {
      chapter: (chapter.chapter_id_display ?? chapter.chapter_id.replace(/^chap_/, "")).toLowerCase()
    }
  }));
}

const { chapter } = Astro.params;
const chapterRecord =
  getChapters().find(
    (record) => record.chapter_id_display?.toLowerCase() === chapter.toLowerCase()
  ) ?? null;
const chapterId = chapterRecord?.chapter_id ?? `chap_${chapter.toLowerCase()}`;
const sections = getSectionsByChapterId(chapterId).slice().sort((left, right) => {
  const leftId = left.section_id.replace(/^secs?_/, "");
  const rightId = right.section_id.replace(/^secs?_/, "");
  return leftId.localeCompare(rightId, undefined, {
    numeric: true,
    sensitivity: "base"
  });
});
const titleId = sections[0]?.title_id ?? null;
const chapterDisplay = chapterRecord?.chapter_id_display ?? chapter;
const chapterLabel = chapterDisplay.toUpperCase();
const chapterTitle = chapterRecord?.chapter_title
  ? chapterRecord.chapter_title.replace(/^Chapter\s+[^-]+-\s+/i, "").trim()
  : null;
const titleDisplay = chapterRecord?.title_id_display ?? titleId;
const titleLabel = titleDisplay ? titleDisplay.toUpperCase() : null;

const buildSectionHref = (sectionId) => {
  if (!sectionId) return null;
  const rawId = sectionId.replace(/^secs?_/, "");
  const [titleSlug, suffix] = rawId.split("-", 2);
  return `/sections/${titleSlug}/${suffix}/`;
};
---

<Base
  title={`Authority · Chapter ${chapterLabel}`}
  description={`Browse Chapter ${chapterLabel} sections.`}
>
  <main class="chapter-page">
    <section class="section-heading">
      {titleLabel && (
        <div class="statute-breadcrumbs">
          <a href={`/titles/${(titleDisplay ?? titleId)?.toLowerCase()}/`}>Title {titleLabel}</a>
          <span class="crumb-sep">•</span>
          <span>Chapter {chapterLabel}</span>
        </div>
      )}
      <h1>{chapterTitle ?? `Chapter ${chapterLabel}`}</h1>
    </section>

    <section class="section-block">
      <div class="section-title">
        <h2>Sections</h2>
      </div>
      <div class="section-list">
        {sections.map((section) => (
          <a
            class="section-row"
            href={buildSectionHref(section.section_id)}
          >
            <span class="section-number">{section.section_number}</span>
            <span class="section-title-text">
              {section.section_title ?? section.section_label}
            </span>
          </a>
        ))}
      </div>
    </section>
  </main>
</Base>
